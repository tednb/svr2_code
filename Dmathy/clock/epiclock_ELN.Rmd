---
title: "CLOCK"
output:
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
knitr::opts_knit$set(root.dir = "/mnt/local-disk/data/guoxiaolong/Renv")
```

```{r ALL}
output_file <- file("output.txt")
sink(output_file, append = TRUE)
load("~/data/infinium/liver_sample/341_liver_samples/RData/GSE180474_he.Rd")
source("~/code/Dmathy/code/ELN_clock.R")
load("~/result/clock/train/GSE180474_clock.Rd")
GPL <- fread("~/data/infinium/GPL_files/GPL13534/GPL13534-11288.txt", header = T)
GPL <- as.data.frame(GPL)
common_cpg <- intersect(GPL$ID,rownames(he.o@m))
idx <- match(common_cpg,rownames(he.o@m))
m_450k <- he.o@m[idx,]
he_450k <- new("qc.o")
he_450k@m <- m_450k
he_450k@s <- he.o@s
he_450k@ctf.o <- he.o@ctf.o
```

```{r}
# 1. test
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/train/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/train/"
he.o@name <- "GSE180474"
# sets <- extract(he.o,seed = 1234)
# trainset <- sets[[1]]
# testset <- sets[[2]]ã€

covs <- model.matrix(~ sex + t2d, data = he.o@s)
seqs <- seq(0.001,0.7,0.001)
re_epic <- clock(he.o,covs,seqs)
re_ben_e <-bench(he.o,seqs)
re_450k <- clock(he_450k,covs,seqs)
re_ben_4 <- bench(he_450k,seqs)
save(re_epic,re_ben_4,re_450k,re_ben,file = paste0(he.o@name,"_clock.Rd"))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))
clock_epic <- re_epic[[1]]
clock_ben_e <- re_ben_e[[1]]
clock_450k <- re_450k[[1]]
clock_ben_4 <- re_ben_4[[1]]
sink()
```

```{r}
# 2. GSE123995
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/HEP/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/HEP/"
load("~/data/infinium/liver_sample/AA_hepatocytes/GSE123995_qc.Rd")
gse <- "GSE123995"
age_hep <- validate(qc.o,clock_epic,gse)
age_all_hep <- validate(qc.o,clock_ben_e,gse)
age_hov_hep <- iageF(PredTage(qc.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))

# 3. GSE103078
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/40/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/40/"
load("~/data/infinium/liver_sample/40_normal_liver_samples/GSE107038_qc.Rd")
gse <- "GSE103078"
age_40 <- validate(qc_107038.o,clock_450k,gse)
age_40_all <- validate(qc_107038.o,clock_ben_4,gse)
age_40_hov <- iageF(PredTage(qc_107038.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))

# 4. GSE61446
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/obese/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/obese/"
load("~/data/infinium/liver_sample/67_obese_livers/GSE61446/GSE61446_qc.Rd")
gse <- "GSE61446"
age_ob <- validate(qc.o,clock_450k,gse)
age_all_ob <- validate(qc.o,clock_ben_4,gse)
age_ob_hov <- iageF(PredTage(qc.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))

# 5. GSE61258
load("~/data/infinium/liver_sample/79_livers(25_healthy)/GSE61258/GSE61258_he.Rd")
load("~/data/infinium/liver_sample/79_livers(25_healthy)/GSE61258/GSE61258_qc.Rd")
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/32/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/32/"
gse <- "GSE61258"
age_25 <- validate(he.o,clock_450k,gse)
age_25_all <- validate(he.o,clock_ben_4,gse)
age_25_hov <- iageF(PredTage(he.o@m))
 age_79 <- validate(qc.o,clock_450k,gse)
 age_79_all <- validate(qc.o,clock_ben_4,gse)
 age_79_hov <- iageF(PredTage(qc.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))
# 6. Validating on CD4T: GSE56581
load("~/data/infinium/purified_blood/GSE56581/ReynoldsCD4T_he.Rd")
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/CD4/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/CD4/"
gse <- "GSE56581_CD4"
age_cd4 <- validate(CD4T_qc.o,clock_450k,gse)
age_cd4_all <- validate(CD4T_qc.o,clock_ben_4,gse)
age_cd4_hov <- iageF(PredTage(CD4T_qc.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))


load("~/data/infinium/purified_blood/GSE56056/GSE56046_he.Rd")
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/MONO/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/MONO/"
gse <- "GSE56046_MONO"
age_mono <- validate(mono_he.o,clock_450k,gse)
age_mono_all <- validate(mono_he.o,clock_ben_4,gse)
age_mono_hov <- iageF(PredTage(mono_he.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))
# 7. Validating on kidney , colon and prostate
# colon
load("~/data/infinium/colon/GSE131013/GSE131013_he.Rd")
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/colon/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/colon/"
gse <- "GSE131013"
age_colon <- validate(he_colon.o,clock_450k,gse)
age_colon_all <- validate(he_colon.o,clock_ben_4,gse)
age_colon_hov <- iageF(PredTage(he_colon.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))
# prostate
load("~/data/infinium/prostate/GSE76938_he.Rd")
gse <- "GSE76938"
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/prostate/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/prostate/"
age_pros <- validate(hey.o,clock_450k,gse)
age_pros_all <- validate(hey.o,clock_ben_4,gse)
age_pros_hov <- iageF(PredTage(hey.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))
# kidney
load("~/data/infinium/kidney/GSE79100/GSE79100_qc.Rd")
gse <- "GSE79100"
dir.create("/mnt/local-disk/data/guoxiaolong/Renv/kidney/")
new_folder_path <-"/mnt/local-disk/data/guoxiaolong/Renv/kidney/"
age_kid <- validate(qc.o,clock_450k,gse)
age_kid_all <- validate(qc.o,clock_ben_4,gse)
age_kid_hov <- iageF(PredTage(qc.o@m))
file.copy(from = list.files(path = "/mnt/local-disk/data/guoxiaolong/Renv/", pattern = ".pdf|.Rd"), to = new_folder_path, overwrite = TRUE)
file.remove(list.files("/mnt/local-disk/data/guoxiaolong/Renv", pattern = ".pdf|.Rd"))

```

7\. Comparing the age acceleration between normal liver and diseased or obese liver in GSE61258

```{r}
library(ggplot2)
library(tidyr)
load("~/data/infinium/liver_sample/79_livers(25_healthy)/GSE61258/GSE61258_qc.Rd")
df_mix_age <-  data.frame(age_79_all$All, age_79$Hep,age_79_hov)
#EAA
df_mix <- df_mix_age
for(s in 1:ncol(df_mix)){
   df_mix[,s] <- resid(lm(df_mix_age[,s]~qc.o@s$age))
  #df_mix[,s] <- df_mix_age[,s]-qc.o@s$age
}
#IAA
for(s in 1:ncol(df_mix)){
   df_mix[,s] <- resid(lm(df_mix_age[,s]~qc.o@s$age + qc.o@ctf.o[[1]][,1] + qc.o@ctf.o[[1]][,2] + qc.o@ctf.o[[1]][,3] + qc.o@ctf.o[[1]][,4]))
}
df_mix[,2] <- resid(lm(df_mix_age[,2]~qc.o@s$age+qc.o@ctf.o[[1]][,3]))
colnames(df_mix) <- c("All","Hep","Hov")
ill <- qc.o@s$disease
df_mix$bmi <- qc.o@s$bmi
df_mix$ill <- as.numeric(ill)
df_mix <- df_mix[df_mix$ill<3,]
df_mix <- df_mix[,-5]
group <- ifelse(df_mix$bmi<=25,0,ifelse(df_mix$bmi > 30,2,1))
df_mix$gr <- factor(group)
```


```{r combine plot}
library(gridExtra)

# generate the plots
p1 <- ggplot(df_mix,aes(x = gr,y = All)) +
  geom_boxplot(alpha = 0) + theme_bw() +
  geom_jitter(aes(color = gr),size = 2) +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_smooth(aes(group = 1),method = "lm", se = FALSE, color = "#4D7F92", linetype = "dashed")+
  labs(x = "Group",y = "Age acceleration (years)") +
  ggtitle("benchmark clock")+
  ylim(-20,40) +
  annotate("text",x = 1,y = 35,label = paste0("PCC: ",format(cor(df_mix$bmi,df_mix$All),digits=2),", ","P = ",format(cor.test(df_mix$bmi,df_mix$All)$p.value,digits =1)),size = 3) +
  theme(legend.position = "none")

p2 <- ggplot(df_mix,aes(x = gr,y = Hep)) +
  geom_boxplot(alpha = 0) + theme_bw() +
  geom_jitter(aes(color = gr),size = 2) +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_smooth(aes(group = 1),method = "lm", se = FALSE, color = "#F6C25F",linetype = "dashed")+
  labs(x = "Group",y = "Age acceleration (years)") +
  ggtitle("Hepatocyte clock")+
  ylim(-20,40) +
  annotate("text",x = 1,y = 35,label = paste0("PCC: ",format(cor(df_mix$bmi,df_mix$Hep),digits=2),", ","P = ",format(cor.test(df_mix$bmi,df_mix$Hep)$p.value,digits =1)),size = 3) +
  theme(legend.position = "none")

p3 <- ggplot(df_mix,aes(x = gr,y = Hov)) +
  geom_boxplot(alpha = 0) + theme_bw() +
  geom_jitter(aes(color = gr),size = 2) +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_smooth(aes(group = 1),method = "lm", se = FALSE, color = "#775CA5",linetype = "dashed")+
  labs(x = "Group",y = "Age acceleration (years)") +
  ggtitle("Horvath clock")+
  ylim(-20,40) +
  annotate("text",x = 1,y = 35,label = paste0("PCC: ",format(cor(df_mix$bmi,df_mix$Hov),digits=2),", ","P = ",format(cor.test(df_mix$bmi,df_mix$Hov)$p.value,digits =1)),size = 3) +
  theme(legend.position = "none")

# combine the plots
pdf("IAA_res.pdf", width = 12, height = 4)
grid.arrange(p1, p2, p3, ncol = 3)
dev.off()

```

```{r}
df_mix_ob <- df_mix[df_mix$ill %in% c(1,2),]
df_mix_ob <- df_mix_ob[,-c(4:7)] 
p <- c()
for (i in c(1:4)){
      p[i] <-format(wilcox.test(df_mix_ob[,i],mu = 0,alternative = "two.sided")$p.value,scientific = TRUE,digits=1)
}
acc_df <- gather(df_mix_ob,clock,age_acc)
pdf("GSE61258_age-acc.pdf",width = 6,height = 6)
ggplot(acc_df,aes(x = clock,y = age_acc,fill = clock)) +
geom_boxplot() + theme_bw() +
# compare the significance of age acceleration of chol and hep with all
theme(legend.position = "right") + 
labs(x = "Clocks",y = "Age acceleration (years)") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
# add a title
scale_fill_manual(values = c("red","blue","green","purple")) + 
ggtitle("Obese liver age acceleration predicted by different clocks")+
# add a dashed line of y = 0
geom_hline(yintercept = 0,linetype = "dashed",color = "black")+
# hide gridding lines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
guides(fill=guide_legend(title=NULL))+
# hide xlab
theme(axis.title.x = element_blank())+
# y sacle: -30 to 30
ylim(-30,30)+
# add p-value
annotate("text",x = "All",y = 30,label = p[1],size = 3)+
annotate("text",x = "Chol",y = 30,label = p[2],size = 3)+
annotate("text",x = "Hep",y = 30,label = p[3],size = 3)+
annotate("text",x = "Hov",y = 30,label = p[4],size = 3)
dev.off()
```

```{r}
#Draw a boxplot of age acceleration against different disease status, in the boxplot each status has 3 boxplots, which represent the age acceleration of 3 cell types.
pdf("GSE61258_age-acc.pdf",width = 6,height = 6)
# Using one boxplot to display all cell types
p <- ggplot(acc_pr,aes(x = ill,y = age_acc,fill = clock)) + 
geom_boxplot() + theme_bw() + 
theme(legend.position = "right") + 
labs(x = "Disease status",y = "Age acceleration (years)") + 
scale_fill_manual(values = c("red","blue","green")) + 
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
# hide the title of legend
guides(fill=guide_legend(title=NULL))+
# add a title
ggtitle("Age acceleration predicted by different clocks")+
# add a dashed line of y = 0
geom_hline(yintercept = 0,linetype = "dashed",color = "black")+
# hide gridding lines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p_list <- ggplot_build(p)
x_pos<-as.numeric(p_list$data[[1]]$x)
# add p-value
 xpos <- 0.75
 k <- 0.75
for (i in 1:3){
  for(b in levels(df_mix$ill)){
    print(xpos)
    # get the y position of the p-value
    pos <- max(df_mix[which(df_mix$ill==b),i])
    # add the p-value
    p <- p + annotate("text",x = xpos,y = pos+2,label = format(ps[[i]][[b]],digits = 2),size = 3)
  xpos <- xpos + 1
  
  }
  xpos <- k+0.25
  k <- k +0.25
}

p
dev.off()


```

8\. Comparing the age acceleration between normal liver and obese liver Using GSE61446

```{r}
library(ggsignif)
load("~/data/infinium/liver_sample/67_obese_livers/GSE61446/GSE61446_qc.Rd")
acc_pre <- list()
age_df <- list("All" = age_all_ob$All[,1],"Hep"= age_ob$Hep[,1],"Hov" = age_ob_hov)
#1# EAA
for (i in 1:length(age_df)){
# calculate the age acceleration
acc_pre[[i]] <- age_df[[i]] - qc.o@s$age # ordinary
#acc_pre[[i]] <- resid(lm(age_df[[i]]~qc.o@s$age)) # resid method
}
#2# IAA
for (i in 1:length(age_df)){
# calculate the age acceleration
acc_pre[[i]] <- resid(lm(age_df[[i]]~qc.o@s$age + qc.o@ctf.o[[1]][,1] + qc.o@ctf.o[[1]][,2] + qc.o@ctf.o[[1]][,3] + qc.o@ctf.o[[1]][,4])) # ordinary
}
acc_pre[[2]] <- resid(lm(age_df[[i]]~qc.o@s$age))
acc_pre <- as.data.frame(acc_pre)
# Change the sequence of all and hep
colnames(acc_pre) <- c("All","Hep","Hov")

# acc_o <- acc_pre
# acc_o$bmi <- qc.o@s$bmi
# acc_h <- age_h - qc.o@s$age
# acc_o$Hov <- acc_h
# acc_o$hep_f <- qc.o@ctf.o[[1]][,3]

library(tidyr)
acc_pr <- gather(acc_pre,clock,age_acc)
#Draw a boxplot of age acceleration of different cell types
# Use different colors to represent different cell types
p <- c()
for (i in 1:3){
p[i] <-format(wilcox.test(acc_pre[,i],mu = 0,alternative = "greater")$p.value,scientific = TRUE,digits=1)}

```

```{r}
pdf("bmi-aa_gse61446.pdf",width = 8,height = 8)
par(mfrow=c(2,2))
plot(acc_o$bmi,acc_o$Hep,xlab = "BMI",ylab = "Age acceleration",main = "Hep")
abline(lm(acc_o$Hep~acc_o$bmi))
text(x=65,y=20,label = paste0("PCC: ",format(cor(acc_o$bmi,acc_o$Hep),digits=2),", ","P = ",format(cor.test(acc_o$bmi,acc_o$Hep)$p.value,digits =1)))
# plot(acc_o$bmi,acc_o$Chol,xlab = "BMI",ylab = "Age acceleration",main = "Chol")
# abline(lm(acc_o$Chol~acc_o$bmi))
# text(x=65,y=-25,label = paste0("PCC: ",format(cor(acc_o$bmi,acc_o$Chol),digits=2),", ","P = ",format(cor.test(acc_o$bmi,acc_o$Chol)$p.value,digits =1)))
plot(acc_o$bmi,acc_o$All,xlab = "BMI",ylab = "Age acceleration",main = "All")
abline(lm(acc_o$All~acc_o$bmi))
text(x=65,y=-15,label = paste0("PCC: ",format(cor(acc_o$bmi,acc_o$All),digits=2),", ","P = ",format(cor.test(acc_o$bmi,acc_o$All)$p.value,digits =1)))
plot(acc_o$bmi,acc_o$Hov,xlab = "BMI",ylab = "Age acceleration",main = "Hov")
abline(lm(acc_o$Hov~acc_o$bmi))
text(x=65,y=-10,label = paste0("PCC: ",format(cor(acc_o$bmi,acc_o$Hov),digits=2),", ","P = ",format(cor.test(acc_o$bmi,acc_o$Hov)$p.value,digits =1)))
dev.off()
```

```{r}

pdf("bmi-aa_gse61258.pdf",width = 9,height = 3)
par(mfrow=c(1,3))
plot(df_mix$bmi,df_mix$Hep,xlab = "BMI",ylab = "Age acceleration",main = "Hep")
abline(lm(df_mix$Hep~df_mix$bmi))
text(x=55,y=25,label = paste0("PCC: ",format(cor(df_mix$bmi,df_mix$Hep),digits=2),", ","P = ",format(cor.test(df_mix$bmi,df_mix$Hep)$p.value,digits =1)))
plot(df_mix$bmi,df_mix$All,xlab = "BMI",ylab = "Age acceleration",main = "All")
abline(lm(df_mix$All~df_mix$bmi))
text(x=55,y=-15,label = paste0("PCC: ",format(cor(df_mix$bmi,df_mix$All),digits=2),", ","P = ",format(cor.test(df_mix$bmi,df_mix$All)$p.value,digits =1)))
plot(df_mix$bmi,df_mix$Hov,xlab = "BMI",ylab = "Age acceleration",main = "Hov")
abline(lm(df_mix$Hov~df_mix$bmi))
text(x=55,y=-15,label = paste0("PCC: ",format(cor(df_mix$bmi,df_mix$Hov),digits=2),", ","P = ",format(cor.test(df_mix$bmi,df_mix$Hov)$p.value,digits =1)))
dev.off()
```

210

```{r}
acc_he <- acc[acc$ill == 3,]
acc_he <- acc_he[,-c(4:7,9)] 
p <- c()
for (i in c(1:4)){
      p[i] <-format(wilcox.test(acc_he[,i],mu = 0,alternative = "greater")$p.value,scientific = TRUE,digits=1)
}
acc_df <- gather(acc_he,clock,age_acc)

pdf("24_age-acc.pdf",width = 6,height = 6)
ggplot(acc_df,aes(x = clock,y = age_acc,fill = clock)) +
geom_boxplot() + theme_bw() +
# compare the significance of age acceleration of chol and hep with all
theme(legend.position = "right") + 
labs(x = "Clocks",y = "Age acceleration (years)") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
# add a title
scale_fill_manual(values = c("red","blue","green","purple")) + 
ggtitle("24 grade4 samples age acceleration")+
# add a dashed line of y = 0
geom_hline(yintercept = 0,linetype = "dashed",color = "black")+
# hide gridding lines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
guides(fill=guide_legend(title=NULL))+
# hide xlab
theme(axis.title.x = element_blank())+
# y sacle: -30 to 30
ylim(-30,30)+
# add p-value
annotate("text",x = "All",y = 30,label = p[1],size = 3)+
annotate("text",x = "Chol",y = 30,label = p[2],size = 3)+
annotate("text",x = "Hep",y = 30,label = p[3],size = 3)+
annotate("text",x = "Hov",y = 30,label = p[4],size = 3)
dev.off()
```

```{r}
pdf("bmi-aa_210.pdf",width = 8,height = 8)
par(mfrow=c(2,2))
plot(he.o@s$bmi,acc_he$Hep,xlab = "BMI",ylab = "Age acceleration",main = "Hep")
abline(lm(acc_he$Hep~he.o@s$bmi))
text(x=70,y=15,label = paste0("PCC: ",format(cor(he.o@s$bmi,acc_he$Hep),digits=2),", ","P = ",format(cor.test(he.o@s$bmi,acc_he$Hep)$p.value,digits =1)))
plot(he.o@s$bmi,acc_he$Chol,xlab = "BMI",ylab = "Age acceleration",main = "Chol")
abline(lm(acc_he$Chol~he.o@s$bmi))
text(x=70,y=15,label = paste0("PCC: ",format(cor(he.o@s$bmi,acc_he$Chol),digits=2),", ","P = ",format(cor.test(he.o@s$bmi,acc_he$Chol)$p.value,digits =1)))
plot(he.o@s$bmi,acc_he$All,xlab = "BMI",ylab = "Age acceleration",main = "All")
abline(lm(acc_he$All~he.o@s$bmi))
text(x=70,y=10,label = paste0("PCC: ",format(cor(he.o@s$bmi,acc_he$All),digits=2),", ","P = ",format(cor.test(he.o@s$bmi,acc_he$All)$p.value,digits =1)))
plot(he.o@s$bmi,acc_he$Hov,xlab = "BMI",ylab = "Age acceleration",main = "Hov")
abline(lm(acc_he$Hov~he.o@s$bmi))
text(x=70,y=-15,label = paste0("PCC: ",format(cor(he.o@s$bmi,acc_he$Hov),digits=2),", ","P = ",format(cor.test(he.o@s$bmi,acc_he$Hov)$p.value,digits =1)))
dev.off()
```

```{r}
pdf("GSE61446_IAA_bmi.pdf",width = 4,height = 4)
ggplot(acc_pr,aes(x = clock,y = age_acc,fill = clock)) +
# points

geom_boxplot() + 
  geom_point(position = position_jitterdodge(),size = 0.5) +
  theme_bw() +
# compare the significance of age acceleration of chol and hep with all
theme(legend.position = "right") + 
labs(x = "Clocks",y = "Age acceleration (years)") +
# add a title
scale_fill_manual(values = c("#4E8397","#FFC75F","#845EC2")) + 
ggtitle("IAA of obese livers (n=67)")+
# add a dashed line of y = 0
geom_hline(yintercept = 0,linetype = "dashed",color = "black")+
# hide gridding lines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
guides(fill=guide_legend(title=NULL))+
# hide xlab
theme(axis.title.x = element_blank())+
# y sacle: -30 to 30
ylim(-30,30)+
# add p-value
annotate("text",x = "All",y = 28,label = paste0("P= ",format(p[1],digits = 2)),size = 3)+
annotate("text",x = "Hep",y = 28,label = paste0("P= ",format(p[2],digits = 2)),size = 3)+
annotate("text",x = "Hov",y = 28,label = paste0("P= ",format(p[3],digits = 2)),size = 3)+
# remove legend
theme(legend.position = "none")
dev.off()

```

8.  Applying Horvath clock

```{r}
# GSE180474
load("~/data/infinium/liver_sample/341_liver_samples/RData/GSE180474_qc.Rd")
H_de_age<-iageF(PredTage(qc_te.o@m))
H_he_age<-iageF(PredTage(he.o@m))
H_age <- c(H_he_age,H_de_age)
acc_h <- H_age - c(he.o@s$age,qc_te.o@s$age)
```

9.  Comparing the age acceleration between normal liver and NAFLD liver Using GSE180474

```{r}
load("~/data/infinium/liver_sample/341_liver_samples/RData/GSE180474_qc.Rd")

library(tidyr)
idx <- which(qc.o@s$desease!=0)
m <- qc.o@m[,idx]
s <- qc.o@s[idx,]
qc_te.o <- new("qc.o")
qc_te.o@m <- m
qc_te.o@s <- s
qc_te.o@ctf.o[[1]] <- qc.o@ctf.o[[1]][idx,]
gse <- "GSE180474"
age_de_c <- validate(qc_te.o,clock_epic,gse)
age_de_a <- validate(qc_te.o,clock_ben_e,gse)
H_de_age <- iageF(PredTage(qc_te.o@m))
age_de <- list(age_de_c$Hep[,1],age_de_a$All[,1],H_de_age)
acc_de <- list()
# EAA
for (i in 1:length(age_de)){
# calculate the age acceleration
acc_de[[i]] <- resid(lm(age_de[[i]]~qc_te.o@s$age)) # resid method
#acc_de[[i]] <-age_de[[i]] - qc_te.o@s$age
}
# IAA
for (i in 1:length(age_de)){
# calculate the age acceleration
acc_de[[i]] <- resid(lm(age_de[[i]]~qc_te.o@s$age + qc_te.o@ctf.o[[1]][,1] + qc_te.o@ctf.o[[1]][,2] + qc_te.o@ctf.o[[1]][,3] + qc_te.o@ctf.o[[1]][,4])) # resid method
}
acc_de[[1]] <- resid(lm(age_de[[1]]~qc_te.o@s$age))
acc_de <- as.data.frame(acc_de)
colnames(acc_de) <- c("Hep","All","Hov") # ILL AGE ACCELERATION
# nafld
acc_na<-acc_de[which(qc_te.o@s$desease == 1),]
library(tidyr)
acc_npr <- gather(acc_na,clock,age_acc)
#Draw a boxplot of age acceleration of different cell types
# Use different colors to represent different cell types
p <- c()
for (i in 1:3){
p[i] <-format(wilcox.test(acc_na[,i],mu = 0,alternative = "greater")$p.value,scientific = TRUE,digits=1)}


```

```{r}

#Draw a boxplot of age acceleration against different disease status, in the boxplot each status has 3 boxplots, which represent the age acceleration of 3 cell types.
pdf("GSE180474_IAA_disease.pdf",width = 4,height = 4)
ggplot(acc_npr,aes(x = clock,y = age_acc,fill = clock)) +
# points

geom_boxplot() + 
  geom_point(position = position_jitterdodge(),size = 0.5) +
  theme_bw() +
# compare the significance of age acceleration of chol and hep with all
theme(legend.position = "right") + 
labs(x = "Clocks",y = "Age acceleration (years)") +
# add a title
scale_fill_manual(values = c("#4E8397","#FFC75F","#845EC2")) + 
ggtitle("IAA of NAFLD livers (n=55)")+
# add a dashed line of y = 0
geom_hline(yintercept = 0,linetype = "dashed",color = "black")+
# hide gridding lines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
guides(fill=guide_legend(title=NULL))+
# hide xlab
theme(axis.title.x = element_blank())+
# y sacle: -30 to 30
ylim(-30,30)+
# add p-value
annotate("text",x = "All",y = 28,label = paste0("P= ",format(p[2],digits = 2)),size = 3)+
annotate("text",x = "Hep",y = 28,label = paste0("P= ",format(p[1],digits = 2)),size = 3)+
annotate("text",x = "Hov",y = 28,label = paste0("P= ",format(p[3],digits = 2)),size = 3)+
# remove legend
theme(legend.position = "none")
dev.off()
```

10. correlation between clocks

```{r}
ages<-re_epic[[2]]$age_pre
ages[[3]] <- re_ben_e[[2]]
ages <- as.data.frame(ages)
colnames(ages) <- c("Hep","Chol","All")
pdf("age-correlation.pdf",width = 10,height = 8)
par(mfrow=c(2,2))
# correlation between ages of different clocks
r <- cor(ages$Chol,ages$Hep,method = "pearson")
# p-value of correlation
p <- cor.test(ages$Chol,ages$Hep,method = "pearson")$p.value
plot(ages$Chol,ages$Hep,xlab = "Age predicted by Chol clock",ylab = "Age predicted by Hep clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)

r <- cor(ages$Chol,ages$All,method = "pearson")
p <- cor.test(ages$Chol,ages$All,method = "pearson")$p.value
plot(ages$Chol,ages$All,xlab = "Age predicted by Chol clock",ylab = "Age predicted by All clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
r <- cor(ages$Hep,ages$All,method = "pearson")
# p-value of correlation
p <- cor.test(ages$Hep,ages$All,method = "pearson")$p.value
plot(ages$Hep,ages$All,xlab = "Age predicted by Hep clock",ylab = "Age predicted by All clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
dev.off()


```

11 acc cor

```{r}
# correlation between age acceleration of different clocks
accs_odi <- ages
accs_odi$Chol <- accs_odi$Chol - he.o@s$age
accs_odi$Hep <- accs_odi$Hep - he.o@s$age
accs_odi$All <- accs_odi$All - he.o@s$age
accs_rsi <- ages
accs_rsi$Chol <- resid(lm(ages$Chol ~ he.o@s$age))
accs_rsi$Hep <- resid(lm(ages$Hep ~ he.o@s$age))
accs_rsi$All <- resid(lm(ages$All ~ he.o@s$age))
pdf("age-acc-correlation.pdf",width = 12,height = 8)
par(mfrow=c(2,3))
r <- cor(accs_odi$Chol,accs_odi$Hep,method = "pearson")
p <- cor.test(accs_odi$Chol,accs_odi$Hep,method = "pearson")$p.value
plot(accs_odi$Chol,accs_odi$Hep,xlab = "Age acceleration predicted by Chol clock",ylab = "Age acceleration predicted by Hep clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
r <- cor(accs_odi$Chol,accs_odi$All,method = "pearson")
p <- cor.test(accs_odi$Chol,accs_odi$All,method = "pearson")$p.value
plot(accs_odi$Chol,accs_odi$All,xlab = "Age acceleration predicted by Chol clock",ylab = "Age acceleration predicted by All clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
r <- cor(accs_odi$Hep,accs_odi$All,method = "pearson")
p <- cor.test(accs_odi$Hep,accs_odi$All,method = "pearson")$p.value
plot(accs_odi$Hep,accs_odi$All,xlab = "Age acceleration predicted by Hep clock",ylab = "Age acceleration predicted by All clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
r <- cor(accs_rsi$Chol,accs_rsi$Hep,method = "pearson")
p <- cor.test(accs_rsi$Chol,accs_rsi$Hep,method = "pearson")$p.value
plot(accs_rsi$Chol,accs_rsi$Hep,xlab = "Age acceleration predicted by Chol clock",ylab = "Age acceleration predicted by Hep clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
r <- cor(accs_rsi$Chol,accs_rsi$All,method = "pearson")
p <- cor.test(accs_rsi$Chol,accs_rsi$All,method = "pearson")$p.value
plot(accs_rsi$Chol,accs_rsi$All,xlab = "Age acceleration predicted by Chol clock",ylab = "Age acceleration predicted by All clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
r <- cor(accs_rsi$Hep,accs_rsi$All,method = "pearson")
p <- cor.test(accs_rsi$Hep,accs_rsi$All,method = "pearson")$p.value
plot(accs_rsi$Hep,accs_rsi$All,xlab = "Age acceleration predicted by Hep clock",ylab = "Age acceleration predicted by All clock",main = paste("r = ",format(r, digits = 3),", p = ",format(p, digits = 1)))
abline(0,1,lty = 2)
dev.off()
```

# figure 2

training result

```{r}
# draw scatterplot for predicted age in re_epic[[2]]$age_pre with chronological age in he.o@s$age using ggplot2
# first, create a data frame
pdf("hep_clock.pdf",width = 4,height = 4)
ages <- data.frame(Hep = re_epic[[2]]$age_pre[[1]],Chol = re_epic[[2]]$age_pre[[2]],All = re_ben_e[[2]],true = he.o@s$age)
r <- cor(ages$Hep,ages$true,method = "pearson")
p <- cor.test(ages$Hep,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Hep - ages$true))
# then, draw scatterplot
library(ggplot2)
ggplot(ages,aes(x = true,y = Hep))+
#orange points
geom_point(size = 0.7,colour = "#F4B183")+
 labs(x = "Chronological age",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(10,80)+
ylim(10,80)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)
dev.off()
pdf("chol_clock.pdf",width = 4,height = 4)
r <- cor(ages$Chol,ages$true,method = "pearson")
p <- cor.test(ages$Chol,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Chol - ages$true))
# then, draw scatterplot
library(ggplot2)
ggplot(ages,aes(x = true,y = Chol))+
#orange points
geom_point(size = 0.7,colour = "#A9D18E")+
 labs(x = "Chronological age",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
#hide y axis title and ticks

  xlim(10,80)+
ylim(10,80)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)
dev.off()
pdf("all_clock.pdf",width = 4,height = 4)
r <- cor(ages$All,ages$true,method = "pearson")
p <- cor.test(ages$All,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$All - ages$true))
# then, draw scatterplot
library(ggplot2)
ggplot(ages,aes(x = true,y = All))+
#orange points
geom_point(size = 0.7,colour = "black")+
 labs(x = "Chronological age",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
#hide y axis title and ticks
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(10,80)+
ylim(10,80)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)
dev.off()
```

GSE107038:40

```{r}
ages <- data.frame(Hep = age_40[[1]][,1],Chol = age_40[[2]][,1],All = age_40_all[[1]][,1],true = qc_107038.o@s$age, Hov = age_40_hov)
r <- cor(ages$Hep,ages$true,method = "pearson")
p <- cor.test(ages$Hep,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Hep - ages$true))
pdf("hep_40.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = Hep))+
#orange points
geom_point(size = 2,colour = "#F4B183")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(10,90)+
ylim(10,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Hepatocyte clock")
dev.off()
r <- cor(ages$Chol,ages$true,method = "pearson")
p <- cor.test(ages$Chol,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Chol - ages$true))

pdf("chol_40.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = Chol))+
#orange points
geom_point(size = 2,colour = "#A9D18E")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
  xlim(10,90)+
ylim(10,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Cholangiocyte clock")
dev.off()
r <- cor(ages$All,ages$true,method = "pearson")
p <- cor.test(ages$All,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$All - ages$true))

pdf("All_40.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = All))+
#orange points
geom_point(size = 2,colour = "black")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(10,90)+
ylim(10,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Benchmark clock")
dev.off()

r <- cor(ages$Hov,ages$true,method = "pearson")
p <- cor.test(ages$Hov,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Hov - ages$true))
pdf("Hov_40.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = Hov))+
#orange points
geom_point(size = 2,colour = "purple")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(10,90)+
ylim(10,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Horvath clock")
dev.off()





```

gse123995:culture

```{r}
ages <- data.frame(Hep = age_hep[[1]][,1],Chol = age_hep[[2]][,1],All = age_all_hep[[1]][,1],true = qc.o@s$age,Hov = age_hov_hep)
r <- cor(ages$Hep,ages$true,method = "pearson")
p <- cor.test(ages$Hep,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Hep - ages$true))
pdf("hep_cul.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = Hep))+
#orange points
geom_point(size = 2,colour = "#F4B183")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(-15,90)+
ylim(-15,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Hepatocyte clock")
dev.off()
r <- cor(ages$Chol,ages$true,method = "pearson")
p <- cor.test(ages$Chol,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Chol - ages$true))
pdf("chol_cul.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = Chol))+
#orange points
geom_point(size = 2,colour = "#A9D18E")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
  xlim(-15,90)+
ylim(-15,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Cholangiocyte clock")
dev.off()
r <- cor(ages$All,ages$true,method = "pearson")
p <- cor.test(ages$All,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$All - ages$true))
pdf("All_cul.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = All))+
#orange points
geom_point(size = 2,colour = "black")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(-15,90)+
ylim(-15,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Benchmark clock")
dev.off()

r <- cor(ages$Hov,ages$true,method = "pearson")
p <- cor.test(ages$Hov,ages$true,method = "pearson")$p.value
mae <- mean(abs(ages$Hov - ages$true))
pdf("Hov_hep.pdf",width = 4,height = 4)
ggplot(ages,aes(x = true,y = Hov))+
#orange points
geom_point(size = 2,colour = "purple")+
 labs(x = "Chronological age (years)",y = "DNAm age")+
 geom_abline(intercept = 0,slope = 1,linetype = "dashed")+ 
# hide axis line and using grid instead
theme(axis.line = element_blank())+
theme(axis.title.y = element_blank(),axis.ticks.y = element_blank())+
  xlim(-15,90)+
ylim(-15,90)+# add correlation coefficient,pvalue and MAE
# add correlation coefficient,pvalue and MAE,
annotate("text",x = 35,y = 80,label = paste("PCC = ",format(r, digits = 2),", P = ",format(p, digits = 1)),size = 5)+
annotate("text",x = 20,y = 75,label = paste("MAE = ",format(mae, digits = 2)),size = 5)+
# add a title
ggtitle("Horvath clock")
dev.off()




```

MAE and PCC in each dataset

```{r}
# calculate RMSE for each clock in all dataset
rmse <- function(x,y){
  sqrt(mean((x-y)^2))
}
load("~/data/infinium/liver_sample/40_normal_liver_samples/GSE107038_qc.Rd")
rmse_40 <- c(rmse(age_40[[1]][,1],qc_107038.o@s$age),rmse(age_40[[2]][,1],qc_107038.o@s$age),rmse(age_40_all[[1]][,1],qc_107038.o@s$age))
pcc_40 <- c(cor(age_40[[1]][,1],qc_107038.o@s$age)
            ,cor(age_40[[2]][,1],qc_107038.o@s$age)
            ,cor(age_40_all[[1]][,1],qc_107038.o@s$age)
            ,cor(age_40_hov,qc_107038.o@s$age))
mae_40 <- c(median(abs(age_40[[1]][,1]-qc_107038.o@s$age))
            ,median(abs(age_40[[2]][,1]-qc_107038.o@s$age))
            ,median(abs(age_40_all[[1]][,1]-qc_107038.o@s$age))
            ,median(abs(age_40_hov-qc_107038.o@s$age)))

load("~/data/infinium/liver_sample/AA_hepatocytes/GSE123995_qc.Rd")
rmse_hep <-  c(rmse(age_hep[[1]][,1],qc.o@s$age),rmse(age_hep[[2]][,1],qc.o@s$age),rmse(age_all_hep[[1]][,1],qc.o@s$age))
pcc_hep <- c(cor(age_hep[[1]][,1],qc.o@s$age)
             ,cor(age_hep[[2]][,1],qc.o@s$age)
             ,cor(age_all_hep[[1]][,1],qc.o@s$age)
             ,cor(age_hov_hep,qc.o@s$age)
             )
mae_hep <- c(median(abs(age_hep[[1]][,1]-qc.o@s$age)),
             median(abs(age_hep[[2]][,1]-qc.o@s$age)),
             median(abs(age_all_hep[[1]][,1]-qc.o@s$age))
             ,median(abs(age_hov_hep-qc.o@s$age)))
load("~/data/infinium/liver_sample/67_obese_livers/GSE61446/GSE61446_qc.Rd")
rmse_obese <- c(rmse(age_ob[[1]][,1],qc.o@s$age),rmse(age_ob[[2]][,1],qc.o@s$age),rmse(age_all_ob[[1]][,1],qc.o@s$age))
pcc_obese <- c(cor(age_ob[[1]][,1],qc.o@s$age)
               ,cor(age_ob[[2]][,1],qc.o@s$age)
               ,cor(age_all_ob[[1]][,1],qc.o@s$age)
               ,cor(age_ob_hov,qc.o@s$age))
mae_obese <- c(median(abs(age_ob[[1]][,1]-qc.o@s$age))
               ,median(abs(age_ob[[2]][,1]-qc.o@s$age))
               ,median(abs(age_all_ob[[1]][,1]-qc.o@s$age))
               ,median(abs(age_ob_hov-qc.o@s$age)))
load("~/data/infinium/liver_sample/79_livers(25_healthy)/GSE61258/GSE61258_he.Rd")
rmse_25 <- c(rmse(age_25[[1]][,1],he.o@s$age),rmse(age_25[[2]][,1],he.o@s$age),rmse(age_25_all[[1]][,1],he.o@s$age))
pcc_25 <- c(cor(age_25[[1]][,1],he.o@s$age)
            ,cor(age_25[[2]][,1],he.o@s$age)
            ,cor(age_25_all[[1]][,1],he.o@s$age)
            ,cor(age_25_hov,he.o@s$age))
mae_25 <- c(median(abs(age_25[[1]][,1]-he.o@s$age))
            ,median(abs(age_25[[2]][,1]-he.o@s$age))
            ,median(abs(age_25_all[[1]][,1]-he.o@s$age))
            ,median(abs(age_25_hov-he.o@s$age)))
load("~/data/infinium/purified_blood/GSE56581/ReynoldsCD4T_he.Rd")
rmse_cd4 <- c(rmse(age_cd4[[1]][,1],CD4T_qc.o@s$age),rmse(age_cd4[[2]][,1],CD4T_qc.o@s$age),rmse(age_cd4_all[[1]][,1],CD4T_qc.o@s$age))
pcc_cd4 <- c(cor(age_cd4[[1]][,1],CD4T_qc.o@s$age)
             ,cor(age_cd4[[2]][,1],CD4T_qc.o@s$age)
             ,cor(age_cd4_all[[1]][,1],CD4T_qc.o@s$age)
             ,cor(age_cd4_hov,CD4T_qc.o@s$age))
mae_cd4 <- c(median(abs(age_cd4[[1]][,1]-CD4T_qc.o@s$age))
             ,median(abs(age_cd4[[2]][,1]-CD4T_qc.o@s$age))
             ,median(abs(age_cd4_all[[1]][,1]-CD4T_qc.o@s$age))
             ,median(abs(age_cd4_hov-CD4T_qc.o@s$age)))
load("~/data/infinium/purified_blood/GSE56056/GSE56046_he.Rd")
rmse_mono <- c(rmse(age_mono[[1]][,1],mono_he.o@s$age),rmse(age_mono[[2]][,1],mono_he.o@s$age),rmse(age_mono_all[[1]][,1],mono_he.o@s$age))
pcc_mono <- c(cor(age_mono[[1]][,1],mono_he.o@s$age)
              ,cor(age_mono[[2]][,1],mono_he.o@s$age)
              ,cor(age_mono_all[[1]][,1],mono_he.o@s$age)
              ,cor(age_mono_hov,mono_he.o@s$age))
mae_mono <- c(median(abs(age_mono[[1]][,1]-mono_he.o@s$age))
              ,median(abs(age_mono[[2]][,1]-mono_he.o@s$age))
              ,median(abs(age_mono_all[[1]][,1]-mono_he.o@s$age))
              ,median(abs(age_mono_hov-mono_he.o@s$age)))
load("~/data/infinium/colon/GSE131013/GSE131013_he.Rd")
rmse_colon <- c(rmse(age_colon[[1]][,1],he_colon.o@s$age),rmse(age_colon[[2]][,1],he_colon.o@s$age),rmse(age_colon_all[[1]][,1],he_colon.o@s$age))
pcc_colon <- c(cor(age_colon[[1]][,1],he_colon.o@s$age)
               ,cor(age_colon[[2]][,1],he_colon.o@s$age)
               ,cor(age_colon_all[[1]][,1],he_colon.o@s$age)
               ,cor(age_colon_hov,he_colon.o@s$age))
mae_colon <- c(median(abs(age_colon[[1]][,1]-he_colon.o@s$age))
               ,median(abs(age_colon[[2]][,1]-he_colon.o@s$age))
               ,median(abs(age_colon_all[[1]][,1]-he_colon.o@s$age))
               ,median(abs(age_colon_hov-he_colon.o@s$age)))
load("~/data/infinium/prostate/GSE76938_he.Rd")
rmse_pros <- c(rmse(age_pros[[1]][,1],hey.o@s$age),rmse(age_pros[[2]][,1],hey.o@s$age),rmse(age_pros_all[[1]][,1],hey.o@s$age))
pcc_pros <- c(cor(age_pros[[1]][,1],hey.o@s$age)
              ,cor(age_pros[[2]][,1],hey.o@s$age)
              ,cor(age_pros_all[[1]][,1],hey.o@s$age)
              ,cor(age_pros_hov,hey.o@s$age))
mae_pros <- c(median(abs(age_pros[[1]][,1]-hey.o@s$age))
              ,median(abs(age_pros[[2]][,1]-hey.o@s$age))
              ,median(abs(age_pros_all[[1]][,1]-hey.o@s$age))
              ,median(abs(age_pros_hov-hey.o@s$age)))
load("~/data/infinium/kidney/GSE79100_qc.Rd")
rmse__kid <- c(rmse(age_kid[[1]][,1],qc.o@s$age),rmse(age_kid[[2]][,1],qc.o@s$age),rmse(age_kid_all[[1]][,1],qc.o@s$age))
pcc_kid <- c(cor(age_kid[[1]][,1],qc.o@s$age)
             ,cor(age_kid[[2]][,1],qc.o@s$age)
             ,cor(age_kid_all[[1]][,1],qc.o@s$age)
             ,cor(age_kid_hov,qc.o@s$age))
mae_kid <- c(median(abs(age_kid[[1]][,1]-qc.o@s$age))
             ,median(abs(age_kid[[2]][,1]-qc.o@s$age))
             ,median(abs(age_kid_all[[1]][,1]-qc.o@s$age))
             ,median(abs(age_kid_hov-qc.o@s$age)))
# combine rmse into a dataframe
rmse_df <- data.frame(rmse_hep,rmse_40,rmse_25,rmse_obese,rmse_cd4,rmse_mono,rmse_colon,rmse_pros,rmse__kid)
pcc_df <- data.frame(pcc_40,pcc_25,pcc_hep,pcc_obese,pcc_cd4,pcc_mono,pcc_colon,pcc_pros,pcc_kid)
mae_df <- data.frame(mae_hep,mae_40,mae_25,mae_obese,mae_cd4,mae_mono,mae_colon,mae_pros,mae_kid)
# add rownames
library(tidyr)
library(dplyr)
rownames(rmse_df) <- c("Hep","Chol","All")
rmse_df <- rmse_df %>%
  tibble::rownames_to_column(var = "clock")
rmse_df <-  rmse_df %>% 
  gather(key = "dataset",value = "rmse",2:10) %>% 
  mutate(dataset = factor(dataset,levels = c("rmse_hep","rmse_40","rmse_25","rmse_obese","rmse_cd4","rmse_mono","rmse_colon","rmse_pros","rmse__kid"),labels = c("Hepatocytes (n=55)","Normal (n=40)","Normal (n=25)","Obese (n=67)","CD4T (n=214)","Monocyte (n=1202)","Colon (n=96)","Prostate (n=51)","Kidney (n=93)")))
rownames(pcc_df) <- c("Hep","Chol","All","Hov")
pcc_df <- pcc_df[-2,]
pcc_df <- pcc_df %>%
  tibble::rownames_to_column(var = "clock") %>% 
  gather(key = "dataset",value = "pcc",2:10) %>% 
  mutate(dataset = factor(dataset,levels = c("pcc_hep","pcc_40","pcc_25","pcc_obese","pcc_cd4","pcc_mono","pcc_colon","pcc_pros","pcc_kid"),labels = c("Hepatocytes (n=55)","Normal (n=40)","Normal (n=25)","Obese (n=67)","CD4T (n=214)","Monocyte (n=1202)","Colon (n=96)","Prostate (n=51)","Kidney (n=93)")))
rownames(mae_df) <- c("Hep","Chol","All","Hov")
mae_df <- mae_df[-2,]
mae_df <- mae_df %>%
  tibble::rownames_to_column(var = "clock") %>% 
  gather(key = "dataset",value = "mae",2:10) %>% 
  mutate(dataset = factor(dataset,levels = c("mae_hep","mae_40","mae_25","mae_obese","mae_cd4","mae_mono","mae_colon","mae_pros","mae_kid"),labels = c("Hepatocytes (n=55)","Normal (n=40)","Normal (n=25)","Obese (n=67)","CD4T (n=214)","Monocyte (n=1202)","Colon (n=96)","Prostate (n=51)","Kidney (n=93)")))
```

```{r}


# draw barplot for pcc using ggplot2
pdf("pcc.pdf",width = 3.5,height = 4)
ggplot(pcc_df,aes(x = dataset,y = pcc,fill = clock))+
  geom_bar(stat = "identity",position = "dodge")+
  labs(x = "Datasets",y = "PCC")+
  scale_fill_manual(values = c("Hep" = "#FFC75F","All" = "#4E8397","Hov" = "#845EC2"))+
  guides(fill = guide_legend(title = NULL))+
  #ggtitle("Pearson Correlation Coefficient")+
  theme_bw()+theme(legend.position = c(0.5,0.9),legend.direction = "horizontal")+
  theme(panel.background = element_rect(fill = "white",colour = "white"))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_rect(xmin = 0.55,xmax = 1.45,ymin = 0,ymax = -1,fill = "#4FFBDF",alpha = 0.1)+
  geom_rect(xmin = 1.55,xmax = 4.45,ymin = 0,ymax = -1,fill = "#2C73D2",alpha = 0.1)+
  geom_rect(xmin = 4.55,xmax = 6.45,ymin = 0,ymax = -1,fill = "#FFB6C1",alpha = 0.1)+
  geom_rect(xmin = 6.55,xmax = 7.45,ymin = 0,ymax = -1,fill = "#F6C8FF",alpha = 0.1)+
  geom_rect(xmin = 7.55,xmax = 8.45,ymin = 0,ymax = -1,fill = "#008F7A",alpha = 0.1)+
  geom_rect(xmin = 8.55,xmax = 9.45,ymin = 0,ymax = -1,fill = "#DEB887",alpha = 0.1)+
  theme(axis.text.x = element_text(angle = 45,hjust = 1))+
  theme(legend.position = "none")
dev.off()
# draw barplot for mae
pdf("mae.pdf",width = 3.5,height = 4)
ggplot(mae_df,aes(x = dataset,y = mae,fill = clock))+
  geom_bar(stat = "identity",position = "dodge")+
  labs(x = "Datasets",y = "MAE")+
  scale_fill_manual(values = c("Hep" = "#FFC75F","All" = "#4E8397","Hov" = "#845EC2"))+
  guides(fill = guide_legend(title = NULL))+
  #ggtitle("Median Absolute Error")+
  theme_bw()+theme(legend.position = c(0.9,0.9),legend.direction = "horizontal")+
  theme(panel.background = element_rect(fill = "white",colour = "white"))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  geom_rect(xmin = 0.55,xmax = 1.45,ymin = 0,ymax = -1,fill = "#4FFBDF",alpha = 0.1)+
  geom_rect(xmin = 1.55,xmax = 4.45,ymin = 0,ymax = -1,fill = "#2C73D2",alpha = 0.1)+
  geom_rect(xmin = 4.55,xmax = 6.45,ymin = 0,ymax = -1,fill = "#FFB6C1",alpha = 0.1)+
  geom_rect(xmin = 6.55,xmax = 7.45,ymin = 0,ymax = -1,fill = "#F6C8FF",alpha = 0.1)+
  geom_rect(xmin = 7.55,xmax = 8.45,ymin = 0,ymax = -1,fill = "#008F7A",alpha = 0.1)+
  geom_rect(xmin = 8.55,xmax = 9.45,ymin = 0,ymax = -1,fill = "#DEB887",alpha = 0.1)+
  theme(axis.text.x = element_text(angle = 45,hjust = 1))+
  #hide legend
  theme(legend.position = "none")
dev.off()
```
